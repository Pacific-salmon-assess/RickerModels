---
title: "Ricker models for harrison data"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r load, include=FALSE}
library(ggplot2)
library(TMB)
library(bayesplot)
library(tmbstan)
library(reshape)
library(xtable)
library(TMBhelper)
library(cowplot)


source("../R/TMB_functions.R")
#read in simple data set
SR <- read.csv("../data/Harrison_simples_Apr18.csv")
iteracs <- 100000


```


# Ricker simple

Simple Ricker model of the form:
$R = a*S*exp(-b*S) *exp(\epsilon)$

$\epsilon \sim N(0,\sigma)$

```{r, echo=FALSE, warning=FALSE,message=FALSE ,results='hide'}



# LM version
srm <- lm(log(SR$R/SR$S_adj)~ SR$S_adj)
a_srm <- srm$coefficients[1]
b_srm <- -srm$coefficients[2]
alpha <- exp(a_srm)

#par(mfrow=c(2,2))
#plot(srm)

##Ricker MSY funtions 
u_msy <- .5*a_srm-0.07*a_srm^2
S_msy <- a_srm/b_srm * (0.5 -0.07 * a_srm);
#
predR1 <- SR$S_adj*exp(a_srm-b_srm*SR$S_adj)
#
mydata<-list(obs_R=(SR$R),obs_S=SR$S_adj)
parameters_simple <- list(
  alpha=(a_srm),
  logbeta = log(b_srm),
  logSigObs= log(.4)  )

simpl<-list(
  dat=mydata,
  params=parameters_simple,
  rndm=NULL,
  dll="Ricker_simple",
  DIR="." )

#compile("../R/Ricker_simple.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="")
dyn.load(dynlib("../R/Ricker_simple"))


obj<-MakeADFun(mydata,parameters_simple,random=NULL,DLL="Ricker_simple")
newtonOption(obj, smartsearch=FALSE)
  
opt<-nlminb(obj$par,obj$fn,obj$gr)

summary(obj$report())

simplepar<-data.frame(parameters=c("a","b","$\\sigma$"),
	values=c(exp(obj$report()$alpha),obj$report()$beta,obj$report()$SigObs))


#sdreport(obj)
#
nparsimple <- 3 
simpleRickerAIC <- 2*nparsimple-2*- opt$objective

#
##diagnosticts
#qqnorm(obj$report()$residuals)
#abline(0,1)
#
SRdiagsimple <- SR
SRdiagsimple$residuals <- obj$report()$residuals
SRdiagsimple$model <- "Simple Ricker"
SRdiagsimple$alpha <- exp(obj$report()$alpha)

##MCMC
simpleB<-list(
  obj=obj,
  nchain=3,
  iter=iteracs,
  lowbd=c(0.1,-13.5,-6.0),
  hibd=c(4.0,-8.5,5.0)
)

posterior_simple <- posteriorsdf(simpleB)

#plots
#plot_posteriors(posterior_simple$posteriors)
#posteriors of derived quantities -- the interesting ones
simpdf <- posterior_simple$posteriors


names(posterior_simple)

a<-(simpdf$value[simpdf$parameters=="alpha"])
alpha<-exp(simpdf$value[simpdf$parameters=="alpha"])
beta<-exp(simpdf$value[simpdf$parameters=="logbeta"])
Smax<-1/exp(simpdf$value[simpdf$parameters=="logbeta"])
sig<-exp(simpdf$value[simpdf$parameters=="logSigObs"])
umsy_simple<-.5*a-0.07*a^2


simpleparb<-data.frame(parameters=c("a","b","$\\sigma$"),
	MLE=c(exp(obj$report()$alpha),obj$report()$beta,obj$report()$SigObs),
	median=c(median(alpha),median(beta),median(sig)),
  low=c(quantile(alpha, probs=0.025), quantile(beta, probs=0.025), quantile(sig, probs=0.025)),
  high=c(quantile(alpha, probs=0.975), quantile(beta, probs=0.975), quantile(sig, probs=0.975)))

knitr::kable(simpleparb)

deriv_posteriors<-data.frame(chains=rep(simpdf$chains[simpdf$parameters=="logbeta"],3),
                             parameters = rep(c("a","b","sigma"),each=length(a)),
                             value = c(a,beta,sig)
                             )


```

```{r table0, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

knitr::kable(simpleparb)
```


```{r simplepost_fig, echo=FALSE, fig.height = 7, fig.width = 10, fig.cap = "Figure 1. Posterior probability distributions for simple Ricker model."}

pm <- ggplot(deriv_posteriors)
pm <- pm + geom_density(aes(x=value, color=chains), size=1.2)
pm <- pm + facet_wrap(~parameters, scales="free",
  labeller = label_parsed)
pm <- pm + theme_bw(16)+labs(colour = "Prior", x="Value", y="Density")
pm <- pm + scale_color_viridis_d(end = 0.8,option = "A")

pm
```

# Ricker with autocorrelation

 Ricker model with autocorrelation in residuals of the form:
$R_t = a*S_t*exp(-b*S_t) *exp(\epsilon_t +\epsilon_{t-1} *\rho)$

$\epsilon \sim N(0,\sigma_{AR})$

$\sigma_{AR} = \sigma * sqrt(1-\rho^2)$

```{r, echo=FALSE, warning=FALSE ,results='hide'}


mydataar<-list(obs_R=(SR$R),obs_S=SR$S_adj)
#
parameters_autocorr <- list(
  alpha=(a_srm),
  logbeta = log(b_srm),
  logSigObs= log(.4), 
  rho=0.3)

#compile("../R/Ricker_autocorr_ch.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="",tracesweep = TRUE)
dyn.load(dynlib("../R/Ricker_autocorr_ch"))
#
objar<-MakeADFun(mydataar,parameters_autocorr,random=NULL,DLL="Ricker_autocorr_ch")
  newtonOption(objar, smartsearch=FALSE)
#  
optar<-nlminb(objar$par,objar$fn,objar$gr)

nparar <- 4
#objar$report()
#TMBAIC(optar) 
autoRickerAIC <- 2*nparar-2*-optar$objective

#
##restab <- data.frame(Parameter=c("$b$","$S_{max}$","\\alpha","$\\rho$",paste("$\\epsilon_{",SR$BroodYear,"}$")),
##          MLE=c(obj$report()$beta,obj$report()$Smax,obj$report()$alpha,obj$report()$rho,obj$report()$epsilon))
#
##xtable(restab, digits=4,caption = "Ricker recruitment autocorrelaton MLE estimates")
#
SRdiagauto<-SR
SRdiagauto$residuals <- objar$report()$residuals
SRdiagauto$model <- "autocorrelation in Recruitment"
SRdiagauto$alpha <- exp(objar$report()$alpha)


##MCMC
autoB<-list(
  obj=objar,
  nchain=3,
  iter=iteracs,
  lowbd=c(0.1,-15.5,-6.0,-1),
  hibd=c(4.0,-8.5,5.0,1)
)

posterior_ar <- posteriorsdf(autoB)

#plots
#plot_posteriors(posterior_simple$posteriors)
#posteriors of derived quantities -- the interesting ones
ardf <- posterior_ar$posteriors


unique(ardf$parameters)

a_ar<-(ardf$value[ardf$parameters=="alpha"])
alpha_ar<-exp(ardf$value[ardf$parameters=="alpha"])
beta_ar<-exp(ardf$value[ardf$parameters=="logbeta"])
Smax_ar<-1/exp(ardf$value[ardf$parameters=="logbeta"])
rho_ar<- 2 * boot::inv.logit(ardf$value[ardf$parameters=="rho"])-1
sig_ar<-exp(ardf$value[ardf$parameters=="logSigObs"])*sqrt(1-rho_ar^2)


umsy_ar<-.5*a_ar-0.07*a_ar^2


#ARpar<-data.frame(
#	values=c(exp(objar$report()$alpha),objar$report()$beta,objar$report()$SigAR))

#knitr::kable(ARpar)
#

arpar<-data.frame(parameters=c("a","b","$\\sigma_{AR}$","$\\rho$"),
	MLE=c(exp(objar$report()$alpha),objar$report()$beta,objar$report()$SigAR,objar$report()$rhoo),
	median=c(median(alpha_ar),median(beta_ar),median(sig_ar),median(rho_ar)),
  low=c(quantile(alpha_ar, probs=0.025), quantile(beta_ar, probs=0.025), 
    quantile(sig_ar, probs=0.025), quantile(rho_ar, probs=0.025)),
  high=c(quantile(alpha_ar, probs=0.975), quantile(beta_ar, probs=0.975), 
    quantile(sig_ar, probs=0.975), quantile(rho_ar, probs=0.975)))


#
#rpar <- ggplot(SRdiagauto)
#rpar <- rpar + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
#rpar <- rpar + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
#rpar <- rpar + geom_hline(yintercept = 0)
#rpar <- rpar + theme_bw(16)
#rpar <- rpar + scale_color_viridis_c(end = 0.8)
#rpar <- rpar + labs(title="autocorrelation in Recruitment", x = "Spawners", y = "Recruits") 
#rpar
#
#
#SRres<-rbind(SRdiagsimple,SRdiagauto)
#
#
#rpall <- ggplot(SRres)
#rpall <- rall + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
#rpall <- rall + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
#rpall <- rall + geom_hline(yintercept = 0)
#rpall <- rall + theme_bw(16)
#
#rpall <- rall + labs(title="autocorrelation in Recruitment", x = "Spawners", y = "Recruits") 
#rpall <- rall + facet_wrap(~ model)
#rpall


deriv_posteriorsar<-data.frame(chains=rep(ardf$chains[ardf$parameters=="logbeta"],4),
                             parameters = rep(c("a","b","sigma","rho"),each=length(a)),
                             value = c(a_ar,beta_ar,sig_ar,rho_ar)
                             )

```

```{r tablear, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

knitr::kable(arpar)
```


```{r arpost_fig, echo=FALSE, fig.height = 7, fig.width = 9, fig.cap = "Figure . Posterior probability distributions for Ricker model with autocorrelation."}

pmar <- ggplot(deriv_posteriorsar)
pmar <- pmar + geom_density(aes(x=value, color=chains), size=1.2)
pmar <- pmar + facet_wrap(~parameters, scales="free",labeller = label_parsed)
pmar <- pmar + theme_bw(16)+labs( x="Value", y="Density")
pmar <- pmar + scale_color_viridis_d(end = 0.8,option = "A")
pmar

```


# Ricker with time-varying productivity


Ricker model with time-varying productivity

$R_t = a_t*S_t*exp(-b*S_t) *exp(\epsilon_t )$

$a_t = a_{t-1} + v_t$

$\epsilon \sim N(0,\sigma)$

$v \sim N(0,\sigma_{a})$

$\sigma_{tot}= sqrt(\sigma^2 + \sigma_{a}^2)$

```{r echo=FALSE, warning=FALSE,message=FALSE ,results='hide'}


mydatatimevar<-list(obs_R=(SR$R),obs_S=SR$S_adj,prbeta1=3,prbeta2=3)
#
#
parameters_recursive <- list(
  alphao=a_srm,
  logbeta = log(b_srm),
  rho=.2,
  #logtheta = log(.8),
  logvarphi= 0.1,
  alpha=rep(0.9,length(SR$R))
  )


recursive<-list(
  dat=mydatatimevar,
  params=parameters_recursive,
  rndm="alpha",
  dll="Rickerkf_ratiovar",
  DIR="."
  )


#compile("../R/Rickerkf_ratiovar.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="",tracesweep = TRUE)
dyn.load(dynlib("../R/Rickerkf_ratiovar"))

 
obj_timevar<-MakeADFun(mydatatimevar,parameters_recursive,random="alpha",DLL="Rickerkf_ratiovar")
newtonOption(obj_timevar, smartsearch=FALSE)

opt_timevar<-nlminb(obj_timevar$par,obj_timevar$fn,obj_timevar$gr)

repkf<-obj_timevar$report()

meanct<-(length(obj_timevar$report()$alpha)-3):length(obj_timevar$report()$alpha)



SRtimevar <-SR
SRtimevar$model <- "time-varying productivity"
SRtimevar$residuals <- repkf$residuals
SRtimevar$alpha <- exp(repkf$alpha)


recursiveB<-list(
  obj=obj_timevar,
  nchain=3,
  iter=iteracs,
  lowbd=c(0.1,-13.5,0.0,-3.0),
  hibd=c(4.0,-9.,1.0,5.0)
)

posterior_recursive<-posteriorsdf(recursiveB)
recrsdf<-posterior_recursive$posteriors

unique(recrsdf$parameters)

a_rb<-(recrsdf$value[recrsdf$parameters=="alphao"])
beta_rb<-exp(recrsdf$value[recrsdf$parameters=="logbeta"])
Smax_rb<-1/exp(recrsdf$value[recrsdf$parameters=="logbeta"])
rho_rb<-(recrsdf$value[recrsdf$parameters=="rho"])
umsy_rb<-.5*a_rb-0.07*a_rb^2
sigtot <- 1/exp(recrsdf$value[recrsdf$parameters=="logvarphi"])

soa <- recrsdf[grep("alpha",recrsdf$parameters),]
soa$umsy=.5*soa$value-0.07*soa$value^2

asummary <- aggregate(soa$value,list(soa$parameters),function(x){quantile(x,probs=c(0.025,.5,.975))})
asummary <- asummary[c(1,12,23,25:30,2:11,13:22,24),]
umsyposteriorsummary<-aggregate(soa$umsy,list(soa$parameters),function(x){quantile(x,probs=c(0.025,.5,.975))})
umsyposteriorsummary<-umsyposteriorsummary[c(1,12,23,25:30,2:11,13:22,24),]



timevar_par<-data.frame(parameters=c("a_[last4]","b","$\\sigma_{tot}$"),
	MLE=c(exp(mean(obj_timevar$report()$alpha[meanct])),obj_timevar$report()$beta,
		sqrt(obj_timevar$report()$sig^2+obj_timevar$report()$tau^2)),
	median=c(exp(mean(asummary$x[27:30,2])),median(beta_rb), median(sigtot)),
  low=c(exp(mean(asummary$x[27:30,1])), quantile(beta_rb, probs=0.025),  quantile(sigtot, probs=0.025)),
  high=c(exp(mean(asummary$x[27:30,3])), quantile(beta_rb, probs=0.975),  quantile(sigtot, probs=0.975)))






deriv_posteriorsrb<-data.frame(chains=rep(recrsdf$chains[recrsdf$parameters=="logbeta"],4),
                             parameters = rep(c("a","b","sigma","frac"),each=length(a)),
                             value = c(a_rb,beta_rb,sigtot,rho_rb)
                             )



```



```{r tablerb, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

knitr::kable(timevar_par, caption = "Parameter estimates for model with time-varying productivity. productivity values are the average for the last 4 years.")
knitr::kable(arpar)
```

```{r rbpost_fig, echo=FALSE, fig.height = 7, fig.width = 9, fig.cap = "Figure 1. Posterior probability distributions for simple Ricker model."}

pmrb <- ggplot(deriv_posteriorsrb)
pmrb <- pmrb + geom_density(aes(x=value, color=chains), size=1.2)
pmrb <- pmrb + facet_wrap(~parameters, scales="free",labeller = label_parsed)
pmrb <- pmrb + theme_bw(16)+labs(colour = "Prior", x="Value", y="Density")
pmrb <- pmrb + scale_color_viridis_d(end = 0.8,option = "A")
pmrb
```
# Ricker model with survival as covariate


In this model we use survival as part of the model. In this version, the classic productivity parameter is replaced by $a*surv_t$ 

$R_t = a*surv_t*S_t*exp(-b*S_t) *exp(\epsilon)$


$\epsilon \sim N(0,\sigma)$

```{r echo=FALSE, warning=FALSE,message=FALSE,results='hide' }

SRsurv <- read.csv("../data/Harrison_simples_survchi.csv")


#stack spawners, recruitments, fecundity, time var prod, survival

ep <- ggplot(SRsurv)
ep <- ep + geom_line(aes(x=BroodYear,y=(Age2Surv)),size=1.2)
ep <- ep + geom_point(aes(x=BroodYear,y=(Age2Surv), col=(Age2Surv)),stroke=3)
ep <- ep + geom_hline(yintercept = mean((SRsurv$Age2Surv),na.rm=T))
ep <- ep + theme_bw(16)
ep <- ep + scale_color_viridis_c(end = 0.8)
ep


 
mydata_surv<-list(obs_R=(SRsurv$R[!is.na(SRsurv$Age2Surv)]),obs_S=SRsurv$S_adj[!is.na(SRsurv$Age2Surv)],
  obs_survival=SRsurv$Age2Surv[!is.na(SRsurv$Age2Surv)])
  
parameters_surv <- list(
  alpha=0.91298,
  logbeta = log(b_srm),
  logSigObs= 0
  )


#compile("../R/Ricker_survival.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="",tracesweep = TRUE)
dyn.load(dynlib("../R/Ricker_survival"))

 
obj_surv<-MakeADFun(mydata_surv,parameters_surv,random=NULL,DLL="Ricker_survival")
newtonOption(obj_surv, smartsearch=FALSE)

#newtonOption(smartsearch=FALSE)

opt_surv<-nlminb(obj_surv$par,obj_surv$fn,obj_surv$gr)
rep_surv<-obj_surv$report()

TMBAIC(opt_surv)


SRsurv$residuals <- obj_surv$report()$residuals
SRsurv$model <- "survival to age 2 as a covariate"


rsp <- ggplot(SRsurv )
rsp <- rsp + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
rsp <- rsp + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
rsp <- rsp + geom_hline(yintercept = 0)
rsp <- rsp + theme_bw(16)
rsp <- rsp + scale_color_viridis_c(end = 0.8)
rsp <- rsp + labs(title ="survival to age 2 as a covariate", x = "Spawners", y = "Recruits") 
rsp


##MCMC
survB<-list(
  obj=obj_surv,
  nchain=3,
  iter=iteracs,
  lowbd=c(0.1,-13.5,-6.0),
  hibd=c(50.0,-8.5,5.0)
)

posterior_surv <- posteriorsdf(survB)

#plots
#plot_posteriors(posterior_simple$posteriors)
#posteriors of derived quantities -- the interesting ones
survdf <- posterior_simple$posteriors


names(posterior_surv)

a<-(survdf$value[survdf$parameters=="alpha"])
alpha<-exp(survdf$value[survdf$parameters=="alpha"])
beta<-exp(survdf$value[survdf$parameters=="logbeta"])
Smax<-1/exp(survdf$value[survdf$parameters=="logbeta"])
sig<-exp(survdf$value[survdf$parameters=="logSigObs"])
umsy_simple<-.5*a-0.07*a^2


#survparb<-data.frame(parameters=c("a","b","$\\sigma$"),
#  MLE=c(exp(obj$report()$alpha),obj$report()$beta,obj$report()$SigObs),
#  median=c(median(alpha),median(beta),median(sig)),
#  low=c(quantile(alpha, probs=0.025), quantile(beta, probs=0.025), quantile(sig, probs=0.025)),
#  high=c(quantile(alpha, probs=0.975), quantile(beta, probs=0.975), quantile(sig, probs=0.975)))
#
#knitr::kable(survparb)
#
#deriv_posteriorssurv<-data.frame(chains=rep(simpdf$chains[simpdf$parameters=="logbeta"],3),
#                             parameters = rep(c("a","b","sigma"),each=length(a)),
#                             value = c(a,beta,sig)
#                             )


```




# Ricker model with survival and fecundity as covariates

In this version of the model we describe the ricker productivity as function of two covariates. the survival index and a fecundity index. We use z-scores for these covariates. 



$R_t = a_t*S_t*exp(-b*S_t) *exp(\epsilon)$
$a_t = a_0+ \gamma_1*surv_t \gamma_2 * fec_t$
$\epsilon \sim N(0,\sigma)$

```{r echo=FALSE, warning=FALSE,message=FALSE ,results='hide'}

survzscore <- (SRsurv$Age2Surv-mean(SRsurv$Age2Surv))/sd(SRsurv$Age2Surv)
feczscore <- (SRsurv$fecundity-mean(SRsurv$fecundity))/sd(SRsurv$fecundity )

sr_surv <- lm(log(SR$R/SR$S_adj)~ (survzscore)+(feczscore) +SR$S_adj)
summary(sr_surv)
#stack spawners, recruitments, fecundity, time var prod, survival

psz <- ggplot(SRsurv)
psz <- psz + geom_line(aes(x=BroodYear,y=survzscore),size=1.2)
psz <- psz + geom_point(aes(x=BroodYear,y=survzscore, col=survzscore),stroke=3)
psz <- psz + geom_hline(yintercept = 0,na.rm=T)
psz <- psz + theme_bw(16)
psz <- psz + scale_color_viridis_c(end = 0.8)


pfz <- ggplot(SRsurv)
pfz <- pfz + geom_line(aes(x=BroodYear,y=feczscore),size=1.2)
pfz <- pfz + geom_point(aes(x=BroodYear,y=feczscore, col=feczscore),stroke=3)
pfz <- pfz + geom_hline(yintercept = 0,na.rm=T)
pfz <- pfz + theme_bw(16)
pfz <- pfz + scale_color_viridis_c(end = 0.8)
 
plot_grid(psz,pfz)

 
mydata_surv_fec<-list(obs_R=(SRsurv$R[!is.na(SRsurv$Age2Surv)]),obs_S=SRsurv$S_adj[!is.na(SRsurv$Age2Surv)],
  obs_survival=survzscore[!is.na(SRsurv$Age2Surv)],obs_fecundity=feczscore[!is.na(SRsurv$Age2Surv)])
  
parameters_surv_fec <- list(
  alpha=0.91298,
  sl_surv=1,
  sl_fec=1,
  logbeta = log(b_srm),
  logSigObs= 0
  )


compile("../R/Ricker_survival_fecundity.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="",tracesweep = TRUE)
dyn.load(dynlib("../R/Ricker_survival_fecundity"))
 
obj_surv_fec<-MakeADFun(mydata_surv_fec,parameters_surv_fec ,random=NULL,DLL="Ricker_survival_fecundity")
newtonOption(obj_surv_fec, smartsearch=FALSE)

#newtonOption(smartsearch=FALSE)


opt_surv_fec<-nlminb(obj_surv_fec$par,obj_surv_fec$fn,obj_surv_fec$gr)
rep_surv_fec<-obj_surv_fec$report()

TMBAIC(opt_surv_fec)


SRsurv$residuals <- obj_surv_fec$report()$residuals
SRsurv$model <- "survival to age 2 as a covariate"


rsp <- ggplot(SRsurv )
rsp <- rsp + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
rsp <- rsp + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
rsp <- rsp + geom_hline(yintercept = 0)
rsp <- rsp + theme_bw(16)
rsp <- rsp + scale_color_viridis_c(end = 0.8)
rsp <- rsp + labs(title ="survival to age 2 and fecundity a covariate", x = "Spawners", y = "Recruits") 
rsp



```


# comparison

```{r echo=FALSE, warning=FALSE,message=FALSE ,results='hide'}

SRsurv2<-SR
SRsurv2$residuals <- obj_surv$report()$residuals
SRsurv2$model <-" Ricker with age 2 survival"
SRsurv2$alpha <-exp(obj_surv$report()$alphat)

SRfec2<-SR
SRfec2$residuals <- obj_surv_fec$report()$residuals
SRfec2$model <-" Ricker with age 2 survival and fecundity"
SRfec2$alpha <- exp(obj_surv_fec$report()$alphat)
allfits<-rbind(SRdiagsimple,SRtimevar,SRdiagauto,SRsurv2,SRfec2)





```



```{r resid_fig, echo=FALSE, fig.height = 7, fig.width = 9, fig.cap = "Figure . Residual comparison with all models."}

pp <- ggplot(allfits )
pp <- pp + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
pp <- pp + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
pp <- pp + geom_hline(yintercept = 0)
pp <- pp + theme_bw(16)
pp <- pp + scale_color_viridis_c(end = 0.8)
pp <- pp + facet_wrap(~model)
pp 

```




```{r prod_fig, echo=FALSE, fig.height = 7, fig.width = 9, fig.cap = "Figure . Productivity comparison with all models."}

ppa <- ggplot(allfits )
ppa <- ppa + geom_line(aes(x=BroodYear,y=alpha, col=model),size=1.2)
ppa <- ppa + geom_point(aes(x=BroodYear,y=alpha, col=model))
ppa <- ppa + theme_bw(16)
ppa <- ppa + scale_color_viridis_d(end = 0.9,option = "C")
ppa 

```

```{r, echo=FALSE, warning=FALSE }


#
#
#
#
#
#rtv <- ggplot(SRtimevar )
#rtv <- rtv + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
#rtv <- rtv + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
#rtv <- rtv + geom_hline(yintercept = 0)
#rtv <- rtv + theme_bw(16)
#rtv <- rtv + scale_color_viridis_c(end = 0.8)
#rtv <- rtv + labs(title ="time-varying productivity", x = "Spawners", y = "Recruits") 
#rtv
#
#
#
aics<-data.frame(model=c("simple ricker", "autocorrelation in Recruitment", "time-varying productivity", 
  "Ricker with survival covariate","Ricker with survival and fecundity covariates" ),
 AIC= c(TMBAIC(opt), TMBAIC(optar),  TMBAIC(opt_timevar), TMBAIC(opt_surv),TMBAIC(opt_surv_fec)),
 deltaAIC= c(TMBAIC(opt), TMBAIC(optar), TMBAIC(opt_timevar), TMBAIC(opt_surv),TMBAIC(opt_surv_fec) )-
 min(c(TMBAIC(opt), TMBAIC(optar), TMBAIC(opt_timevar), TMBAIC(opt_timevar), TMBAIC(opt_surv),TMBAIC(opt_surv_fec))))
knitr::kable(aics)


```