---
title: "Ricker models for Harrison data"
output:
  html_document:
    df_print: paged
  pdf_document: default
bibliography: chinookrpa.json
---

```{r load, include=FALSE}

library(ggplot2)
library(TMB)
library(bayesplot)
library(tmbstan)
library(reshape)
library(xtable)
library(TMBhelper)
library(cowplot)


source("../R/TMB_functions.R")
#read in simple data set
SR <- read.csv("../data/Harrison_simples_Apr18.csv")
iteracs <- 100000


```


# Ricker simple

Simple Ricker model of the form:
$R_{t} = a*S_{t}*exp(-b*S_{t}) *exp(\epsilon_{t})$

$\epsilon \sim N(0,\sigma)$

```{r, echo=FALSE, warning=FALSE,message=FALSE ,results='hide'}



# LM version
srm <- lm(log(SR$R/SR$S_adj)~ SR$S_adj)
a_srm <- srm$coefficients[1]
b_srm <- -srm$coefficients[2]
alpha <- exp(a_srm)

#par(mfrow=c(2,2))
#plot(srm)

##Ricker MSY funtions 
u_msy <- .5*a_srm-0.07*a_srm^2
S_msy <- a_srm/b_srm * (0.5 -0.07 * a_srm);
#
predR1 <- SR$S_adj*exp(a_srm-b_srm*SR$S_adj)
#
mydata<-list(obs_R=(SR$R),obs_S=SR$S_adj)
parameters_simple <- list(
  alpha=(a_srm),
  logbeta = log(b_srm),
  logSigObs= log(.4)  )

simpl<-list(
  dat=mydata,
  params=parameters_simple,
  rndm=NULL,
  dll="Ricker_simple",
  DIR="." )

#compile("../R/Ricker_simple.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="")
dyn.load(dynlib("../R/Ricker_simple"))


obj<-MakeADFun(mydata,parameters_simple,random=NULL,DLL="Ricker_simple")
newtonOption(obj, smartsearch=FALSE)
  
opt<-nlminb(obj$par,obj$fn,obj$gr)

#summary(obj$report())
#sdreport(obj)
simplepar<-data.frame(parameters=c("a","b","$\\sigma$"),
	values=c(exp(obj$report()$alpha),obj$report()$beta,obj$report()$SigObs))


#sdreport(obj)
#
nparsimple <- 3 
simpleRickerAIC <- 2*nparsimple-2*- opt$objective

#
##diagnosticts
#qqnorm(obj$report()$residuals)
#abline(0,1)
#
SRdiagsimple <- SR
SRdiagsimple$residuals <- obj$report()$residuals
SRdiagsimple$model <- "Simple Ricker"
SRdiagsimple$alpha <- exp(obj$report()$alpha)

##MCMC
simpleB<-list(
  obj=obj,
  nchain=3,
  iter=iteracs,
  lowbd=c(0.1,-13.5,-6.0),
  hibd=c(4.0,-8.5,5.0)
)

#posterior_simple <- posteriorsdf(simpleB)

#saveRDS(posterior_simple, "posterior_simple.rds")
posterior_simple <- readRDS("posterior_simple.rds")

#plots
#plot_posteriors(posterior_simple$posteriors)
#posteriors of derived quantities -- the interesting ones
simpdf <- posterior_simple$posteriors


names(posterior_simple)

a<-(simpdf$value[simpdf$parameters=="alpha"])
alpha<-exp(simpdf$value[simpdf$parameters=="alpha"])
beta<-exp(simpdf$value[simpdf$parameters=="logbeta"])
Smax<-1/exp(simpdf$value[simpdf$parameters=="logbeta"])
sig<-exp(simpdf$value[simpdf$parameters=="logSigObs"])
umsy_simple<-.5*a-0.07*a^2


simpleparb<-data.frame(parameters=c("a","b","$\\sigma$"),
	MLE=c(exp(obj$report()$alpha),obj$report()$beta,obj$report()$SigObs),
	median=c(median(alpha),median(beta),median(sig)),
  low=c(quantile(alpha, probs=0.025), quantile(beta, probs=0.025), quantile(sig, probs=0.025)),
  high=c(quantile(alpha, probs=0.975), quantile(beta, probs=0.975), quantile(sig, probs=0.975)))

knitr::kable(simpleparb)

deriv_posteriors<-data.frame(chains=rep(simpdf$chains[simpdf$parameters=="logbeta"],3),
                             parameters = rep(c("a","b","sigma"),each=length(a)),
                             value = c(a,beta,sig)
                             )


```

```{r table0, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

knitr::kable(simpleparb)
```


```{r simplepost_fig, echo=FALSE, fig.height = 7, fig.width = 10, fig.cap = "Figure 1. Posterior probability distributions for simple Ricker model."}

pm <- ggplot(deriv_posteriors)
pm <- pm + geom_density(aes(x=value, color=chains), size=1.2)
pm <- pm + facet_wrap(~parameters, scales="free",
  labeller = label_parsed)
pm <- pm + theme_bw(16)+labs(colour = "Prior", x="Value", y="Density")
pm <- pm + scale_color_viridis_d(end = 0.8,option = "A")

pm
```

# Ricker with autocorrelation

 Ricker model with autocorrelation in residuals of the form: 

$R_t = a*S_t*exp(-b*S_t) *exp(\epsilon_t +\epsilon_{t-1} *\rho)$

$\epsilon \sim N(0,\sigma_{AR})$

$\sigma_{AR} = \sigma * sqrt(1-\rho^2)$

```{r, echo=FALSE, warning=FALSE ,results='hide'}


mydataar<-list(obs_R=(SR$R),obs_S=SR$S_adj)
#
parameters_autocorr <- list(
  alpha=(a_srm),
  logbeta = log(b_srm),
  logSigObs= log(.4), 
  rho=0.3)

#compile("../R/Ricker_autocorr_ch.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="",tracesweep = TRUE)
dyn.load(dynlib("../R/Ricker_autocorr_ch"))
#
objar<-MakeADFun(mydataar,parameters_autocorr,random=NULL,DLL="Ricker_autocorr_ch")
  newtonOption(objar, smartsearch=FALSE)
#  
optar<-nlminb(objar$par,objar$fn,objar$gr)

nparar <- 4
#objar$report()
#TMBAIC(optar) 
autoRickerAIC <- 2*nparar-2*-optar$objective

#
##restab <- data.frame(Parameter=c("$b$","$S_{max}$","\\alpha","$\\rho$",paste("$\\epsilon_{",SR$BroodYear,"}$")),
##          MLE=c(obj$report()$beta,obj$report()$Smax,obj$report()$alpha,obj$report()$rho,obj$report()$epsilon))
#
##xtable(restab, digits=4,caption = "Ricker recruitment autocorrelaton MLE estimates")
#
SRdiagauto<-SR
SRdiagauto$residuals <- objar$report()$residuals
SRdiagauto$model <- "autocorrelation in Recruitment"
SRdiagauto$alpha <- exp(objar$report()$alpha)


##MCMC
autoB<-list(
  obj=objar,
  nchain=3,
  iter=iteracs,
  lowbd=c(0.1,-15.5,-6.0,-2),
  hibd=c(4.0,-7.0,5.0,2)
)

#posterior_ar <- posteriorsdf(autoB)
#saveRDS(posterior_ar, "posterior_ar.rds")
posterior_ar <- readRDS("posterior_ar.rds")
#plots
#plot_posteriors(posterior_simple$posteriors)
#posteriors of derived quantities -- the interesting ones
ardf <- posterior_ar$posteriors


a_ar<-(ardf$value[ardf$parameters=="alpha"])
alpha_ar<-exp(ardf$value[ardf$parameters=="alpha"])
beta_ar<-exp(ardf$value[ardf$parameters=="logbeta"])
logbeta_ar<-(ardf$value[ardf$parameters=="logbeta"])

Smax_ar<-1/exp(ardf$value[ardf$parameters=="logbeta"])
rho_ar<- 2 * boot::inv.logit(ardf$value[ardf$parameters=="rho"])-1
sig_ar<-exp(ardf$value[ardf$parameters=="logSigObs"])*sqrt(1-rho_ar^2)


umsy_ar<-.5*a_ar-0.07*a_ar^2


#ARpar<-data.frame(
#	values=c(exp(objar$report()$alpha),objar$report()$beta,objar$report()$SigAR))

#knitr::kable(ARpar)
#

arpar<-data.frame(parameters=c("a","b","$\\sigma_{AR}$","$\\rho$"),
	MLE=c(exp(objar$report()$alpha),objar$report()$beta,objar$report()$SigAR,objar$report()$rhoo),
	median=c(median(alpha_ar),median(beta_ar),median(sig_ar),median(rho_ar)),
  low=c(quantile(alpha_ar, probs=0.025), quantile(beta_ar, probs=0.025), 
    quantile(sig_ar, probs=0.025), quantile(rho_ar, probs=0.025)),
  high=c(quantile(alpha_ar, probs=0.975), quantile(beta_ar, probs=0.975), 
    quantile(sig_ar, probs=0.975), quantile(rho_ar, probs=0.975)))


#
#rpar <- ggplot(SRdiagauto)
#rpar <- rpar + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
#rpar <- rpar + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
#rpar <- rpar + geom_hline(yintercept = 0)
#rpar <- rpar + theme_bw(16)
#rpar <- rpar + scale_color_viridis_c(end = 0.8)
#rpar <- rpar + labs(title="autocorrelation in Recruitment", x = "Spawners", y = "Recruits") 
#rpar
#
#
#SRres<-rbind(SRdiagsimple,SRdiagauto)
#
#
#rpall <- ggplot(SRres)
#rpall <- rall + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
#rpall <- rall + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
#rpall <- rall + geom_hline(yintercept = 0)
#rpall <- rall + theme_bw(16)
#
#rpall <- rall + labs(title="autocorrelation in Recruitment", x = "Spawners", y = "Recruits") 
#rpall <- rall + facet_wrap(~ model)
#rpall


deriv_posteriorsar<-data.frame(chains=rep(ardf$chains[ardf$parameters=="logbeta"],4),
                             parameters = rep(c("a","b","sigma","rho"),each=length(a)),
                             value = c(a_ar,beta_ar,sig_ar,rho_ar)
                             )

```

```{r tablear, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

knitr::kable(arpar)
```


```{r arpost_fig, echo=FALSE, fig.height = 7, fig.width = 9, fig.cap = "Figure . Posterior probability distributions for Ricker model with autocorrelation."}

pmar <- ggplot(deriv_posteriorsar)
pmar <- pmar + geom_density(aes(x=value, color=chains), size=1.2)
pmar <- pmar + facet_wrap(~parameters, scales="free",labeller = label_parsed)
pmar <- pmar + theme_bw(16)+labs( x="Value", y="Density")
pmar <- pmar + scale_color_viridis_d(end = 0.8,option = "A")
pmar

```


# Ricker with time-varying productivity


Ricker model with time-varying productivity

$R_t = a_t*S_t*exp(-b*S_t) *exp(\epsilon_t )$

$a_t = a_{t-1} + v_t$

$\epsilon \sim N(0,\sigma)$

$v \sim N(0,\sigma_{a})$

$\sigma_{tot}= sqrt(\sigma^2 + \sigma_{a}^2)$

```{r echo=FALSE, warning=FALSE,message=FALSE ,results='hide'}


mydatatimevar<-list(obs_R=(SR$R),obs_S=SR$S_adj,prbeta1=3,prbeta2=3)
#
#
parameters_recursive <- list(
  alphao=a_srm,
  logbeta = log(b_srm),
  rho=.2,
  #logtheta = log(.8),
  logvarphi= 0.1,
  alpha=rep(0.9,length(SR$R))
  )


recursive<-list(
  dat=mydatatimevar,
  params=parameters_recursive,
  rndm="alpha",
  dll="Rickerkf_ratiovar",
  DIR="."
  )


#compile("../R/Rickerkf_ratiovar.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="",tracesweep = TRUE)
dyn.load(dynlib("../R/Rickerkf_ratiovar"))

 
obj_timevar<-MakeADFun(mydatatimevar,parameters_recursive,random="alpha",DLL="Rickerkf_ratiovar")
newtonOption(obj_timevar, smartsearch=FALSE)

opt_timevar<-nlminb(obj_timevar$par,obj_timevar$fn,obj_timevar$gr)

repkf<-obj_timevar$report()

meanct<-(length(obj_timevar$report()$alpha)-3):length(obj_timevar$report()$alpha)



SRtimevar <-SR
SRtimevar$model <- "time-varying productivity"
SRtimevar$residuals <- repkf$residuals
SRtimevar$alpha <- exp(repkf$alpha)


recursiveB<-list(
  obj=obj_timevar,
  nchain=3,
  iter=iteracs,
  lowbd=c(0.1,-13.5,0.0,-3.0),
  hibd=c(4.0,-8.,1.0,5.0)
)

#posterior_recursive<-posteriorsdf(recursiveB)

#saveRDS(posterior_recursive, "posterior_recursive.rds")
posterior_recursive <- readRDS("posterior_recursive.rds")

recrsdf<-posterior_recursive$posteriors

a_rb<-(recrsdf$value[recrsdf$parameters=="alphao"])
beta_rb<-exp(recrsdf$value[recrsdf$parameters=="logbeta"])
Smax_rb<-1/exp(recrsdf$value[recrsdf$parameters=="logbeta"])
rho_rb<-(recrsdf$value[recrsdf$parameters=="rho"])
umsy_rb<-.5*a_rb-0.07*a_rb^2
sigtot <- 1/exp(recrsdf$value[recrsdf$parameters=="logvarphi"])

soa <- recrsdf[grep("alpha",recrsdf$parameters),]
soa$umsy=.5*soa$value-0.07*soa$value^2

asummary <- aggregate(soa$value,list(soa$parameters),function(x){quantile(x,probs=c(0.025,.5,.975))})
asummary <- asummary[c(1,12,23,25:30,2:11,13:22,24),]
umsyposteriorsummary<-aggregate(soa$umsy,list(soa$parameters),function(x){quantile(x,probs=c(0.025,.5,.975))})
umsyposteriorsummary<-umsyposteriorsummary[c(1,12,23,25:30,2:11,13:22,24),]



timevar_par<-data.frame(parameters=c("a_[2010]","a_[2011]","a_[2012]","a_[2013]","a_[avg4]","b","$\\sigma_{tot}$"),
	MLE=c(exp(obj_timevar$report()$alpha[meanct]),
    exp(mean(obj_timevar$report()$alpha[meanct])),obj_timevar$report()$beta,
		sqrt(obj_timevar$report()$sig^2+obj_timevar$report()$tau^2)),
	median=c(exp(asummary$x[27:30,2]),exp(mean(asummary$x[27:30,2])),
    median(beta_rb), median(sigtot)),
  low=c(exp(asummary$x[27:30,1]),exp(mean(asummary$x[27:30,1])), 
    quantile(beta_rb, probs=0.025),  quantile(sigtot, probs=0.025)),
  high=c(exp(asummary$x[27:30,3]),exp(mean(asummary$x[27:30,3])),
   quantile(beta_rb, probs=0.975),  quantile(sigtot, probs=0.975)))






deriv_posteriorsrb<-data.frame(chains=rep(recrsdf$chains[recrsdf$parameters=="logbeta"],4),
                             parameters = rep(c("a","b","si[tot]","frac"),each=length(a)),
                             value = c(a_rb,beta_rb,sigtot,rho_rb)
                             )



```


```{r table, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

knitr::kable(timevar_par, caption = "Parameter estimates for model with time-varying productivity.")

```


```{r rbpost_fig, echo=FALSE, fig.height = 7, fig.width = 9, fig.cap = "Figure. Posterior probability distributions for simple Ricker model."}

pmrb <- ggplot(deriv_posteriorsrb)
pmrb <- pmrb + geom_density(aes(x=value, color=chains), size=1.2)
pmrb <- pmrb + facet_wrap(~parameters, scales="free",labeller = label_parsed)
pmrb <- pmrb + theme_bw(16)+labs(colour = "Prior", x="Value", y="Density")
pmrb <- pmrb + scale_color_viridis_d(end = 0.8,option = "A")
pmrb
```
 
# Ricker model with smolt to age 2 survival as covariate


In this model we use survival as part of the model. In this version, the classic productivity parameter is replaced by $a*surv_t$ 

$R_t = a*surv_t*S_t*exp(-b*S_t) *exp(\epsilon)$


$\epsilon \sim N(0,\sigma)$

```{r echo=FALSE, warning=FALSE,message=FALSE,results='hide' }

SRsurv <- read.csv("../data/Harrison_simples_survchi.csv")


#stack spawners, recruitments, fecundity, time var prod, survival



 
mydata_surv<-list(obs_R=(SRsurv$R[!is.na(SRsurv$Age2Surv)]),obs_S=SRsurv$S_adj[!is.na(SRsurv$Age2Surv)],
  obs_survival=SRsurv$Age2Surv[!is.na(SRsurv$Age2Surv)])
  
parameters_surv <- list(
  alpha=20,
  logbeta = log(b_srm),
  logSigObs= 0
  )


#compile("../R/Ricker_survival.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="",tracesweep = TRUE)
dyn.load(dynlib("../R/Ricker_survival"))

 
obj_surv<-MakeADFun(mydata_surv,parameters_surv,random=NULL,DLL="Ricker_survival")
newtonOption(obj_surv, smartsearch=FALSE)

#newtonOption(smartsearch=FALSE)

opt_surv<-nlminb(obj_surv$par,obj_surv$fn,obj_surv$gr,lower = c(0.1,-13.5,-6.0), upper = c(1000.0,-8.5,5.0))
rep_surv<-obj_surv$report()

TMBAIC(opt_surv)


SRsurv$residuals <- obj_surv$report()$residuals
SRsurv$model <- "survival to age 2 as a covariate"


#rsp <- ggplot(SRsurv )
#rsp <- rsp + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
#rsp <- rsp + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
#rsp <- rsp + geom_hline(yintercept = 0)
#rsp <- rsp + theme_bw(16)
#rsp <- rsp + scale_color_viridis_c(end = 0.8)
#rsp <- rsp + labs(title ="survival to age 2 as a covariate", x = "Spawners", y = "Recruits") 
#rsp


##MCMC
survB<-list(
  obj=obj_surv,
  nchain=3,
  iter=iteracs,
  lowbd=c(0.1,-13.5,-6.0),
  hibd=c(1000.0,-8.5,5.0)
)

#posterior_surv <- posteriorsdf(survB)

#saveRDS(posterior_surv, "posterior_surv.rds")
posterior_surv <- readRDS("posterior_surv.rds")

#plots
#plot_posteriors(posterior_simple$posteriors)
#posteriors of derived quantities -- the interesting ones
survdf <- posterior_surv$posteriors




a_surv<-(survdf$value[survdf$parameters=="alpha"])

aall<-sapply(a_surv,function(x){x*SRsurv$Age2Surv})

alpha_surv<-exp(aall)
beta_surv<-exp(survdf$value[survdf$parameters=="logbeta"])
Smax_surv<-1/exp(survdf$value[survdf$parameters=="logbeta"])
sig_surv<-exp(survdf$value[survdf$parameters=="logSigObs"])


survparb<-data.frame(parameters=c("a[2010]","a[2011]","a[2012]","a[2013]","a[avg]","b","$\\sigma$"),
  MLE=c(exp(obj_surv$report()$alpha*SRsurv$Age2Surv[meanct]),mean(exp(obj_surv$report()$alpha*SRsurv$Age2Surv[meanct])),
    obj_surv$report()$beta,obj_surv$report()$SigObs),
  median=c(apply(alpha_surv,1,median)[meanct],mean(apply(alpha_surv,1,median)[meanct]), 
    median(beta_surv),median(sig_surv)),
  low=c(apply(alpha_surv,1, function(x){quantile(x, probs=0.025)})[meanct],
   mean(apply(alpha_surv,1, function(x){quantile(x, probs=0.025)})[meanct]), quantile(beta_surv, probs=0.025), quantile(sig_surv, probs=0.025)),
  high=c(apply(alpha_surv,1,function(x){quantile(x, probs=0.975)})[meanct], 
    mean(apply(alpha_surv,1,function(x){quantile(x, probs=0.975)})[meanct]), quantile(beta_surv, probs=0.975),
    quantile(sig_surv, probs=0.975)))
#
#knitr::kable(survparb)
#
deriv_posteriorssurv<-data.frame(chains=rep(survdf$chains[survdf$parameters=="logbeta"],3),
                             parameters = rep(c("a","b","sigma"),each=length(beta_surv)),
                             value = c(a_surv,beta_surv,sig_surv)
                             )


```


```{r covsurv g, echo=FALSE, fig.height = 7, fig.width = 17, fig.cap = "Figure. Survival to age two estimates."}

ep <- ggplot(SRsurv)
ep <- ep + geom_line(aes(x=BroodYear,y=Age2Surv),size=1.2)
ep <- ep + geom_point(aes(x=BroodYear,y=Age2Surv, col=(Age2Surv)),stroke=3)
ep <- ep + geom_hline(yintercept = mean((SRsurv$Age2Surv),na.rm=T))
ep <- ep + theme_bw(16)
ep <- ep + scale_color_viridis_c(end = 0.8, option = "A")
ep

```



```{r survpost_fig, echo=FALSE, fig.height = 7, fig.width = 9, fig.cap = "Figure. Posterior probability distributions for Ricker with survival as a covariate."}

pmsurv <- ggplot(deriv_posteriorssurv)
pmsurv <- pmsurv + geom_density(aes(x=value, color=chains), size=1.2)
pmsurv <- pmsurv + facet_wrap(~parameters, scales="free",labeller = label_parsed)
pmsurv <- pmsurv + theme_bw(16)+labs(colour = "Prior", x="Value", y="Density")
pmsurv <- pmsurv + scale_color_viridis_d(end = 0.8,option = "A")
pmsurv
```


```{r tablesurv, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

knitr::kable(survparb, caption = "Parameter estimates for model with survival from smolt to age 2 as a covariate.")

```


# Ricker model with smolt to age 2 survival and fecundity as covariates

In this version of the model we describe the ricker productivity as function of two covariates. The survival index and a fecundity index. We use z-scores for these covariates. 



$R_t = a_t*S_t*exp(-b*S_t) *exp(\epsilon)$

$a_t = a_0+ \gamma_1*surv_t \gamma_2 * fec_t$

$\epsilon \sim N(0,\sigma)$


```{r echo=FALSE, warning=FALSE,message=FALSE ,results='hide'}

survzscore <- (SRsurv$Age2Surv-mean(SRsurv$Age2Surv))/sd(SRsurv$Age2Surv)
feczscore <- (SRsurv$fecundity-mean(SRsurv$fecundity))/sd(SRsurv$fecundity )

sr_surv_fec <- lm(log(SR$R/SR$S_adj)~ (survzscore)+(feczscore) +SR$S_adj)

#stack spawners, recruitments, fecundity, time var prod, survival

psz <- ggplot(SRsurv)
psz <- psz + geom_line(aes(x=BroodYear,y=survzscore),size=1.2)
psz <- psz + geom_point(aes(x=BroodYear,y=survzscore, col=survzscore),stroke=3)
psz <- psz + geom_hline(yintercept = mean(SRsurv$Age2Surv),na.rm=T)
psz <- psz + theme_bw(16)
psz <- psz + scale_color_viridis_c(end = 0.8,option = "A")


pfz <- ggplot(SRsurv)
pfz <- pfz + geom_line(aes(x=BroodYear,y=feczscore),size=1.2)
pfz <- pfz + geom_point(aes(x=BroodYear,y=feczscore, col=feczscore),stroke=3)
pfz <- pfz + geom_hline(yintercept = 0,na.rm=T)
pfz <- pfz + theme_bw(16)
pfz <- pfz + scale_color_viridis_c(end = 0.8,option = "A")
 


 
mydata_surv_fec<-list(obs_R=(SRsurv$R[!is.na(SRsurv$Age2Surv)]),obs_S=SRsurv$S_adj[!is.na(SRsurv$Age2Surv)],
  obs_survival=survzscore[!is.na(SRsurv$Age2Surv)],obs_fecundity=feczscore[!is.na(SRsurv$Age2Surv)])
  
parameters_surv_fec <- list(
  alpha=10,
  sl_surv=1,
  sl_fec=1,
  logbeta = log(b_srm),
  logSigObs= 0
  )


#compile("../R/Ricker_survival_fecundity.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="",tracesweep = TRUE)
dyn.load(dynlib("../R/Ricker_survival_fecundity"))
 
obj_surv_fec<-MakeADFun(mydata_surv_fec,parameters_surv_fec ,random=NULL,DLL="Ricker_survival_fecundity")
newtonOption(obj_surv_fec, smartsearch=FALSE)

#newtonOption(smartsearch=FALSE)


opt_surv_fec<-nlminb(obj_surv_fec$par,obj_surv_fec$fn,obj_surv_fec$gr,lower = c(0.1,-20,-20,-13.5,-6.0), upper = c(100.0,20,20,-8.5,5.0))
rep_surv_fec<-obj_surv_fec$report()

TMBAIC(opt_surv_fec)


SRsurv$residuals <- obj_surv_fec$report()$residuals
SRsurv$model <- "survival to age 2 as a covariate"


#rsp <- ggplot(SRsurv )
#rsp <- rsp + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
#rsp <- rsp + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
#rsp <- rsp + geom_hline(yintercept = 0)
#rsp <- rsp + theme_bw(16)
#rsp <- rsp + scale_color_viridis_c(end = 0.8)
#rsp <- rsp + labs(title ="survival to age 2 and fecundity a covariate", x = "Spawners", y = "Recruits") 
#rsp



##MCMC
survfecB<-list(
  obj=obj_surv_fec,
  nchain=3,
  iter=iteracs,
  lowbd=c(0.1,-20,-20,-13.5,-6.0),
  hibd=c(100.0,20,20,-8.5,5.0)
)



#posterior_survfec <- posteriorsdf(survfecB)
#saveRDS(posterior_survfec, "posterior_survfec.rds")
posterior_survfec <- readRDS("posterior_survfec.rds")

#plots
#plot_posteriors(posterior_simple$posteriors)
#posteriors of derived quantities -- the interesting ones
survfecdf <- posterior_survfec$posteriors


a_survfec <- survfecdf$value[survfecdf$parameters=="alpha"]
slfec <- survfecdf$value[survfecdf$parameters=="sl_fec"]
slsurv <- survfecdf$value[survfecdf$parameters=="sl_surv"]

aallfec <- matrix(NA, nrow=length(SRsurv$Age2Surv), ncol=length(a_survfec))



for(i in seq_along(SRsurv$Age2Surv)){
  #aallfec[i,] <- (a_survfec+sl_fec*feczscore[i])*SRsurv$Age2Surv[i]
   aallfec[i,] <- a_survfec+ slsurv *survzscore[i]+slfec*feczscore[i]         
}

alphaallfec <- exp(aallfec)
beta_survfec <- exp(survfecdf$value[survfecdf$parameters=="logbeta"])
Smax_survfec <- 1/exp(survfecdf$value[survfecdf$parameters=="logbeta"])
sig_survfec <- exp(survfecdf$value[survfecdf$parameters=="logSigObs"])
#sl_surv<-survfecdf$value[survfecdf$parameters=="sl_surv"]



survfecparb<-data.frame(parameters=c("a[2010]","a[2011]","a[2012]","a[2013]","a[avg4]","b","$\\sigma$","surv_sl", "fec_sl"),
  MLE=c(exp(obj_surv_fec$report()$alphat[meanct]),mean(exp(obj_surv_fec$report()$alphat[meanct])),
    obj_surv_fec$report()$beta,obj_surv_fec$report()$SigObs,
    obj_surv_fec$report()$sl_surv,obj_surv_fec$report()$sl_fec),
  median=c(apply(alphaallfec,1,median)[meanct],mean(apply(alphaallfec,1,median)[meanct]),
    median(beta_survfec),median(sig_survfec),median(slsurv),median(slfec)),
  low=c(apply(alphaallfec,1, function(x){quantile(x, probs=0.025)})[meanct],
    mean(apply(alphaallfec,1, function(x){quantile(x, probs=0.025)})[meanct]),
    quantile(beta_survfec, probs=0.025), quantile(sig_survfec, probs=0.025), quantile(slsurv, probs=0.025),
    quantile(slfec, probs=0.025)),
  high=c(apply(alphaallfec,1,function(x){quantile(x, probs=0.975)})[meanct],
   mean(apply(alphaallfec,1,function(x){quantile(x, probs=0.975)})[meanct]),
   quantile(beta_survfec, probs=0.975), quantile(sig_survfec, probs=0.975), 
   quantile(slsurv, probs=0.975), quantile(slfec, probs=0.975)))



deriv_posteriorssurvfec<-data.frame(chains=rep(survfecdf$chains[survfecdf$parameters=="logbeta"],5),
                             parameters = rep(c("a","b","sigma","surv_slope","fec_slope"),each=length(beta_survfec)),
                             value = c(a_survfec,beta_survfec,sig_survfec,slsurv,slfec)
                             )

```



```{r covzscores g, echo=FALSE, fig.height = 7, fig.width = 17, fig.cap = "Figure. z-scores for fecundity and survival covariates"}
plot_grid(psz,pfz)

```





```{r survfecpost_fig, echo=FALSE, fig.height = 7, fig.width = 9, fig.cap = "Figure. Posterior probability distributions for Ricker with survival  and fecundity as a covariates."}

pmsurvfec <- ggplot(deriv_posteriorssurvfec)
pmsurvfec <- pmsurvfec + geom_density(aes(x=value, color=chains), size=1.2)
pmsurvfec <- pmsurvfec + facet_wrap(~parameters, scales="free",labeller = label_parsed)
pmsurvfec <- pmsurvfec + theme_bw(16)+labs(colour = "Prior", x="Value", y="Density")
pmsurvfec <- pmsurvfec + scale_color_viridis_d(end = 0.8,option = "A")
pmsurvfec
```


```{r tablesurvfec, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

knitr::kable(survfecparb, caption = "Parameter estimates for model with survival as a covariate.")

```



# Ricker model with egg to age 2 survival as covariate


In this model we use survival from egg to age 2 as part of the model. In this version, similarly to the model using the smolt to age 2 survival estimates, the classic productivity parameter is replaced by $a*surv_t$ 

$R_t = a*surv_t*S_t*exp(-b*S_t) *exp(\epsilon)$


$\epsilon \sim N(0,\sigma)$

```{r echo=FALSE, warning=FALSE,message=FALSE,results='hide' }

#read in the egg to age tw suviva data- need infilling for 2004
survest <- read.csv("../data/survestimates.csv")



survreg<-lm(survest$ln.egg.to.age.2.survival.~survest$Ln.smolt.to.age.2.surv.)
#summary(survreg)
#predict(survreg,survest)

plot(survest$Ln.smolt.to.age.2.surv.,survest$ln.egg.to.age.2.survival.)
lines(survest$Ln.smolt.to.age.2.surv.,predict(survreg,survest))

SRsurv$eggAge2Surv <- exp(predict(survreg,survest))

#stack spawners, recruitments, fecundity, time var prod, survival

 
mydata_survegg<-list(obs_R=(SRsurv$R),obs_S=SRsurv$S_adj,
  obs_survival=SRsurv$eggAge2Surv)
  
parameters_survegg <- list(
  alpha=20,
  logbeta = log(b_srm),
  logSigObs= 0
  )


#compile("../R/Ricker_survival.cpp",libtmb=FALSE, "-O1 -g", DLLFLAGS="",tracesweep = TRUE)
dyn.load(dynlib("../R/Ricker_survival"))

 
obj_survegg<-MakeADFun(mydata_survegg,parameters_survegg,random=NULL,DLL="Ricker_survival")
newtonOption(obj_survegg, smartsearch=FALSE)

#newtonOption(smartsearch=FALSE)

opt_survegg<-nlminb(obj_survegg$par,obj_survegg$fn,obj_survegg$gr,lower = c(0.1,-13.5,-6.0), upper = c(1000.0,-8.5,5.0))
rep_survegg<-obj_survegg$report()

TMBAIC(opt_survegg)
SRsurvegg<-SRsurv

SRsurvegg$residuals <- obj_survegg$report()$residuals
SRsurvegg$model <- "survival from egg to age 2 as a covariate"


#rsp <- ggplot(SRsurv )
#rsp <- rsp + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
#rsp <- rsp + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
#rsp <- rsp + geom_hline(yintercept = 0)
#rsp <- rsp + theme_bw(16)
#rsp <- rsp + scale_color_viridis_c(end = 0.8)
#rsp <- rsp + labs(title ="survival to age 2 as a covariate", x = "Spawners", y = "Recruits") 
#rsp


##MCMC
survBegg<-list(
  obj=obj_survegg,
  nchain=3,
  iter=iteracs,
  lowbd=c(0.1,-13.5,-6.0),
  hibd=c(1000.0,-8.5,5.0)
)

#posterior_survegg <- posteriorsdf(survBegg)
#saveRDS(posterior_survegg, "posterior_survegg.rds")
posterior_survegg <- readRDS("posterior_survegg.rds")

#plots
#plot_posteriors(posterior_simple$posteriors)
#posteriors of derived quantities -- the interesting ones
survdfegg <- posterior_survegg$posteriors




a_survegg<-(survdfegg$value[survdfegg$parameters=="alpha"])

aallsurvegg<-sapply(a_survegg,function(x){x*SRsurv$eggAge2Surv})

alpha_survegg<-exp(aallsurvegg)
beta_survegg<-exp(survdfegg$value[survdfegg$parameters=="logbeta"])
Smax_survegg<-1/exp(survdfegg$value[survdfegg$parameters=="logbeta"])
sig_survegg<-exp(survdfegg$value[survdfegg$parameters=="logSigObs"])


survparbegg<-data.frame(parameters=c("a[2010]","a[2011]","a[2012]","a[2013]","a[avg]","b","$\\sigma$"),
  MLE=c(exp(obj_survegg$report()$alpha*SRsurv$eggAge2Surv[meanct]),mean(exp(obj_survegg$report()$alpha*SRsurv$eggAge2Surv[meanct])),
    obj_survegg$report()$beta,obj_survegg$report()$SigObs),
  median=c(apply(alpha_survegg,1,median)[meanct],mean(apply(alpha_survegg,1,median)[meanct]), 
    median(beta_survegg),median(sig_survegg)),
  low=c(apply(alpha_survegg,1, function(x){quantile(x, probs=0.025)})[meanct],
   mean(apply(alpha_survegg,1, function(x){quantile(x, probs=0.025)})[meanct]), quantile(beta_survegg, probs=0.025), quantile(sig_survegg, probs=0.025)),
  high=c(apply(alpha_survegg,1,function(x){quantile(x, probs=0.975)})[meanct], 
    mean(apply(alpha_survegg,1,function(x){quantile(x, probs=0.975)})[meanct]), quantile(beta_survegg, probs=0.975),
    quantile(sig_survegg, probs=0.975)))
#
#knitr::kable(survparb)
#
deriv_posteriorssurvegg<-data.frame(chains=rep(survdfegg$chains[survdfegg$parameters=="logbeta"],3),
                             parameters = rep(c("a","b","sigma"),each=length(beta_survegg)),
                             value = c(a_survegg,beta_survegg,sig_survegg)
                             )


```




```{r surveggpost_fig, echo=FALSE, fig.height = 7, fig.width = 9, fig.cap = "Figure. Posterior probability distributions for Ricker with survival from egg to age 2 as a covariate."}

pmsurvegg <- ggplot(deriv_posteriorssurvegg)
pmsurvegg <- pmsurvegg + geom_density(aes(x=value, color=chains), size=1.2)
pmsurvegg <- pmsurvegg + facet_wrap(~parameters, scales="free",labeller = label_parsed)
pmsurvegg <- pmsurvegg + theme_bw(16)+labs(colour = "Prior", x="Value", y="Density")
pmsurvegg <- pmsurvegg + scale_color_viridis_d(end = 0.8,option = "A")
pmsurvegg
```


```{r tablesurvegg, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

knitr::kable(survparbegg, caption = "Parameter estimates for model with survival as a covariate.")

```



# Comparison

Model comparison was based on visual inspection of temporal residual patterns as well as calculated AIC values for the maximum likelihood estimates. Of all the models considered, the state-space model with time-varying productivity is the one with the lowest residual values and absence of a temporal pattern (refer to resid fig). The AIC values, however, indicate that the model that include survival from egg to age 2 as a covariate is the one with the olowest AIC value, despite of more marked emporal residuals resulting from that fit. 

These statistical diagnostics are informative of how the model fits the data, but provide little insight on the potential performance of these models for management advice [@http://zotero.org/users/1231389/items/FENK4JJF]. More recently in the fisheries science literature, there has been a push to base model selection for management advice on closed-loop simulation and managent strategy evaluation analyses [@http://zotero.org/users/1231389/items/3QWU9KPF; @http://zotero.org/users/1231389/items/F6H4Q4JU].  These analyses are beyond the scope of the current RPA, but efforts to establish a MSE process for Chinook salmon in BC are ongoing.  

```{r echo=FALSE, warning=FALSE,message=FALSE ,results='hide'}

SRsurv2<-SR
SRsurv2$residuals <- rep_surv$residuals
SRsurv2$model <-" Ricker with survival from smolt to age 2"
SRsurv2$alpha <-exp(rep_surv$alphat)


SRsurvegg2<-SR
SRsurvegg2$residuals <- obj_survegg$report()$residuals
SRsurvegg2$model <-" Ricker with  survival from egg to age 2"
SRsurvegg2$alpha <-exp(obj_survegg$report()$alphat)

SRfec2<-SR
SRfec2$residuals <- obj_surv_fec$report()$residuals
SRfec2$model <-" Ricker with survival from smolt to age 2 and fecundity"
SRfec2$alpha <- exp(obj_surv_fec$report()$alphat)
allfits<-rbind(SRdiagsimple,SRtimevar,SRdiagauto,SRsurv2,SRfec2,SRsurvegg2)

#write.csv(allfits, file="../data/HarrisonFits.csv", row.names=FALSE)



```



```{r residYR_fig, echo=FALSE, fig.height = 7, fig.width = 12, fig.cap = "Figure . Residual vs. Brood year comparison over years with all models."}

pp <- ggplot(allfits )
pp <- pp + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
pp <- pp + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
pp <- pp + geom_hline(yintercept = 0)
pp <- pp + theme_bw(16)
pp <- pp + scale_color_viridis_c(end = 0.8)
pp <- pp + facet_wrap(~model)
pp 

```



```{r residS_fig, echo=FALSE, fig.height = 7, fig.width = 12, fig.cap = "Figure . Residuals vs Spawners comparison over years with all models."}

psp <- ggplot(allfits )
#psp <- psp + geom_line(aes(x=S_adj,y=residuals),size=1.2)
psp <- psp + geom_point(aes(x=S_adj,y=residuals, col=residuals),stroke=3)
psp <- psp + geom_hline(yintercept = 0)
psp <- psp + theme_bw(16) + xlab("Spawners")
psp <- psp + scale_color_viridis_c(end = 0.8)
psp <- psp + facet_wrap(~model)
psp 

```



```{r prod_fig, echo=FALSE, fig.height = 7, fig.width = 12, fig.cap = "Figure . Productivity comparison with all models."}

ppa <- ggplot(allfits )
ppa <- ppa + geom_line(aes(x=BroodYear,y=alpha, col=model),size=1.2)
ppa <- ppa + geom_point(aes(x=BroodYear,y=alpha, col=model))
ppa <- ppa + theme_bw(16)
ppa <- ppa + scale_color_viridis_d(end = 0.9,option = "C")
ppa 

```

```{r, echo=FALSE, warning=FALSE }


#
#
#
#
#
#rtv <- ggplot(SRtimevar )
#rtv <- rtv + geom_line(aes(x=BroodYear,y=residuals),size=1.2)
#rtv <- rtv + geom_point(aes(x=BroodYear,y=residuals, col=residuals),stroke=3)
#rtv <- rtv + geom_hline(yintercept = 0)
#rtv <- rtv + theme_bw(16)
#rtv <- rtv + scale_color_viridis_c(end = 0.8)
#rtv <- rtv + labs(title ="time-varying productivity", x = "Spawners", y = "Recruits") 
#rtv
#
#
#
aics<-data.frame(model=c("simple ricker", "autocorrelation in Recruitment", "time-varying productivity", 
  "Ricker with survival from smolt to age 2 as a covariate","Ricker with survival from smolt to age 2 and fecundity covariates", "Ricker with survival from egg to age 2 as a covariate"),
 AIC= c(TMBAIC(opt), TMBAIC(optar),  TMBAIC(opt_timevar), TMBAIC(opt_surv),TMBAIC(opt_surv_fec),TMBAIC(opt_survegg)),
 deltaAIC= c(TMBAIC(opt), TMBAIC(optar), TMBAIC(opt_timevar), TMBAIC(opt_surv),TMBAIC(opt_surv_fec), TMBAIC(opt_survegg) )- min(c(TMBAIC(opt), TMBAIC(optar), TMBAIC(opt_timevar), TMBAIC(opt_timevar), TMBAIC(opt_surv),TMBAIC(opt_surv_fec),TMBAIC(opt_survegg))))
knitr::kable(aics)


```

# References